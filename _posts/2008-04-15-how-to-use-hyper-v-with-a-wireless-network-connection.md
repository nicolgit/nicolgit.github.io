---
title: How to use Hyper-V with a wireless network connection
tags: [Hyper-V, Routing]
---
<p>Hyper-V, the fantastic Windows Server 2008 new feature have a small limit I discovered when on my &quot;home/handmade server:-)&quot; I tried to use it. It doesn't manage wireless networks. This is &quot;by design&quot;, as clearly described by <a href="http://blogs.msdn.com/virtual_pc_guy/archive/2008/01/09/using-hyper-v-with-a-wireless-network-adapter.aspx" target="_blank">Ben Armstrong in his blog</a>. This absolutely make sense because Windows Server 2008 and Hyper-V is a server oriented product.</p>  <p>Despite of this, there are scenarios I can define &quot;<em>consumer</em>&quot; or &quot;<em>Lab</em>&quot; oriented where allow to Hyper-V to interact with a wireless network can be required. The scenarios list include:</p>  <ul>   <li>A test server at home connected via wireless to both Internet and other home PCs via a SOHO router (my scenario :-) </li>    <li>A server machine used on a live/conference demo connected to the speaker's PC via wireless&#160; </li> </ul>  <p>For these scenarios, we can identify following connectivity requirements:</p>  <ol>   <li>to allow to guest machine (on Hyper-V) to access to Internet </li>    <li>to allow to guest machine to access to other machines connected to wireless LAN </li>    <li>to allow to other machines connected to the wireless LAN to access to guest machine </li>    <li>to allow to guest machine to be exposed and accessed from Internet </li> </ol>  <p>The great <a href="http://blogs.msdn.com/virtual_pc_guy/archive/2008/01/09/using-hyper-v-with-a-wireless-network-adapter.aspx" target="_blank">Ben's post on this topic</a>, address just the scenario (1) leaving other not covered. Objective of this post is to show a configuration that allow to address all above requirement in 15 minutes or less:-)</p>  <p>--</p>  <p>Well, Hyper-V allows to create &quot;<strong>Internal Virtual Networks</strong>&quot; (IVN). These IVN are networks visible from both HOST and GUEST operating systems. In example if I have an internal virtual network called &quot;<strong>RoI</strong>&quot; (Route over Internet:-) on my host machine (i.e. <strong>SRV04.local</strong>) and the this network is shared with 3 guest machines (<strong>GUEST01.local</strong>, <strong>GUEST02.local</strong>, <strong>GUEST03.local</strong>), I'll have a &quot;virtual&quot; network topology as shown below:</p>  <p><a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/image_2.png" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/image_2.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="207" alt="image" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/image_thumb.png" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/image_thumb.png" width="244" border="0" /></a> </p>  <p>In order to create a new virtual internal network switch you have to:</p>  <ol>   <li>Open the Hyper-V Manager and select your server. </li>    <li>Select <strong>Virtual Network Manager...</strong> from the action pane (on the right). </li>    <li>Select <strong>New virtual network</strong> and choose to <strong>Add</strong> an <strong>Internal</strong> network. </li>    <li>Give the new virtual network the name you want hit <strong>OK</strong>. </li> </ol>  <p>Because <strong>SRV04.local</strong> have a wireless network card too, <strong>SRV04.local</strong> now have 2 network cards. Through this second network card, it is able connect to wireless network (WIRELESS) that allows it to interact with both other PC connected via wireless and to Internet.</p>  <p><a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/image6.png" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/image6.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="244" alt="image" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/image6_thumb.png" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/image6_thumb.png" width="159" border="0" /></a> </p>  <p>Now, in order to allow to GUEST machines to interact with both machines connected to wireless LAN AND Internet we can enable HOST machine (<strong>SRV04.local</strong>) <u>to act as a router</u>.</p>  <p>Windows Server 2008 have a standard role called &quot;<strong>Network Policy and Access Service</strong>&quot; that can be activated to allow this kind of scenario.</p>  <p>Before to proceed, in order to simplify the discussion, let's assume to use following network configuration:</p>  <p><strong>WIRELESS LAN</strong></p>  <ul>   <li>IP Range: <strong>192.168.<font color="#ff0000">1</font>.x</strong> (1&lt;= x &lt;=255) </li>    <li>Subnet Mask: <strong>255.255.255.0</strong> </li>    <li>DNS == Default Gateway == <strong>192.168.1.1</strong> </li>    <li>Wireless LAN is private and router act as a <a href="http://en.wikipedia.org/wiki/Network_address_translation" target="_blank">NAT</a> to allow local machines to access Internet. </li> </ul>  <p><strong>RoI LAN</strong></p>  <ul>   <li>IP Range: <strong>192.168.<font color="#ff0000">2</font>.x</strong> (1&lt;= x &lt;=255) </li>    <li>Subnet Mask <strong>255.255.255.0</strong> </li>    <li>DNS: <strong>192.168.1.1</strong> </li>    <li>Default Gateway: <strong>192.168.2.6</strong> (SRV04 machine on RoI LAN!)</li> </ul>  <p><strong>SRV04</strong></p>  <ul>   <li>IP on Wireless LAN: <strong>192.168.1.6</strong> </li>    <li>IP on RoI LAN: <strong>192.168.2.6</strong> </li> </ul>  <p>&#160;<a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/image_6.png" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/image_6.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="241" alt="image" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/image_thumb_2.png" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/image_thumb_2.png" width="244" border="0" /></a> </p>  <p>Steps required to allow <strong>GUEST01.local</strong> to access to Internet are following:</p>  <ul>   <li>enable and configure &quot;<strong>Network Policy and Access Service</strong>&quot; on <strong>SRV04.local</strong> </li>    <li>add a <strong>static route</strong> on &quot;default gateway&quot; router </li> </ul>  <p>&#160;</p>  <p><strong><u>Step1: how to configure/enable &quot;Network Policy and Access Service&quot;</u></strong></p>  <p>From <strong>Server Manager</strong>, select &quot;<strong>Add Role</strong>&quot;.</p>  <p>Select &quot;<strong>Network Policy and Access Service</strong>&quot;, then click <strong>Next</strong>.</p>  <p><a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture01.jpg" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture01.jpg"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="174" alt="Capture01" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture01_thumb.jpg" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture01_thumb.jpg" width="244" border="0" /></a> </p>  <p>Select &quot;<strong>Remote Access Service</strong>&quot; and &quot;<strong>Routing</strong>&quot; then click <strong>Next</strong>.</p>  <p><a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture02.jpg" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture02.jpg"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="173" alt="Capture02" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture02_thumb.jpg" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture02_thumb.jpg" width="244" border="0" /></a> </p>  <p>Select &quot;<strong>Custom Configuration</strong>&quot; then click <strong>Next</strong>.</p>  <p><a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture03.jpg" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture03.jpg"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="203" alt="Capture03" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture03_thumb.jpg" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture03_thumb.jpg" width="244" border="0" /></a> </p>  <p>Select &quot;<strong>LAN Routing only</strong>&quot; then click <strong>Next</strong>.</p>  <p><a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture04.jpg" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture04.jpg"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="202" alt="Capture04" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture04_thumb.jpg" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture04_thumb.jpg" width="244" border="0" /></a> </p>  <p>when finished, select &quot;<strong>Start Service</strong>&quot; on server manager.</p>  <p><a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture05.jpg" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture05.jpg"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="119" alt="Capture05" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture05_thumb.jpg" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture05_thumb.jpg" width="244" border="0" /></a> </p>  <p>&#160;</p>  <p><strong><u>Step 2: how to configure your default gateway router</u></strong></p>  <p>Previous configuration is not enough to allow routing because you still need to say to your router that addresses <strong>192.168.2.x</strong> must be forwarder to <strong>SRV04.local</strong> machine. You can obtain this adding a <u>static route</u> on your router. Almost every SOHO router of &#8364;50 or more is able to do this, please refer to your router manual to discover how to do this.In example, at home, I have a Netgear toy that shows the following page</p>  <p><a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture06.jpg" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture06.jpg"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="58" alt="Capture06" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_msdn/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture06_thumb.jpg" original-url="http://blogs.msdn.com/blogfiles/nicold/WindowsLiveWriter/HowtouseHyperVwithawirelessnetworkconnec_FBC5/Capture06_thumb.jpg" width="244" border="0" /></a> </p>  <p>In our example have to add a route to <strong>192.168.2.0</strong> mask <strong>255.255.255.0</strong> through <strong>192.168.1.6</strong></p>  <p><strong><font color="#ff0000">And that's all</font></strong>! Now your guest machine can access to Internet. The cool think is that with this configuration, and thanks to your cheap:-) router too, someone from Internet can access to a service based on your <strong>GUEST</strong> machine. In example, if you have an IIS on <strong>GUEST01.local</strong> and you want to show it on Internet, you can use the port forwarding option of your router with following parameters:</p>  <ul>   <li>Service/Port: <strong>80</strong> </li>    <li>Server IP Address: <strong>192.168.2.10</strong> </li> </ul>  <p>Again for more information on port forwarding please refer to your router instruction manual.</p>  <p>This configuration still <u>doesn't</u> allow:</p>  <ul>   <li>Other machines on your wireless LAN to access to <strong>GUEST01.local</strong> </li>    <li><strong>GUEST01.local</strong> to access other machines on your wireless LAN </li> </ul>  <p>This because machines on your wireless LAN have as default gateway <strong>192.168.1.1</strong> and the router is not smart enough to understand that <strong>192.168.2.x</strong> addresses must be routed to <strong>SRV04.local</strong>. The easy solution is to add a static route on each machine connected to the wireless LAN. You can achieve this adding a static route via command prompt with the following instruction:</p>  <ul>   <li><strong>route ADD 192.168.2.0 MASK 255.255.255.0 192.168.1.6</strong> </li> </ul>  <p>Remember that this action, on Vista, <a href="http://www.home-network-help.com/requires-elevation.html" target="_blank">requires elevation</a>.</p>  <p>Thanks to Marcello &quot;<em>router</em>&quot; Formica for the fundamental help:-)</p>
